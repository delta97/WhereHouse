---
title: "Project Group 8"
author: Utkuhan Genc, Cole Parsons, Amanda Crowe, Collin Jewett, Kayla Parker, Michael
  Campbell, Shriya Das
date: "November 5, 2018"
output: html_document
---

```{r setup, eval  = FALSE}
install.packages("zipcode")
install.packages("generator")
install.packages("RMySQL")
install.packages("random")
install.packages("tidyr")
install.packages("sampling")
install.packages("ggmap")
install.packages("rvest")
install.packages("RMySQL")
install.packages("httr")
install.packages("XML")
install.packages("stringi")
install.packages("tidyverse")
install.packages("geosphere")
```

```{r}
library(tidyverse) 
library(generator)
library(zipcode)
library(tidyr)
library(dplyr)
library(sampling)
library(ggmap)
library(rvest)
library(stringr)  
library(ggplot2)
library(stringi)
library(RMySQL)
library(geosphere)
```

```{r}
con <- dbConnect(MySQL(),
         user="g1090429", password="WhereHouse?",
         dbname="g1090429", host="mydb.ics.purdue.edu")
on.exit(dbDisconnect(con))
```

```{r}
all_cons <- dbListConnections(MySQL())
for (con in all_cons)
dbDisconnect(con)
```

```{r user}
#USER DATATABLE
sample_size <- lesse_num + nrow(owner)


#First and Last Names
full_name <- r_full_names(sample_size)
df <- as.data.frame(full_name)
names <- tidyr::separate(df, full_name, sep = " ", c("First_name", "Last_name" ))

#User type
user_type <- as.data.frame(rbinom(sample_size, 1, nrow(owner)/ sample_size))
sum(user_type) - length(user_type)

#Phone Number
Phone_num <- r_phone_numbers(sample_size)
Phone_num <- as.data.frame(Phone_num)

#Email
Email <- r_email_addresses(sample_size)
Email <- as.data.frame(Email)

#Date of Birth 
DOB <- sample(seq(as.Date('1950/01/01'), as.Date('2000/01/01'), by="day"), sample_size, replace = TRUE )
DOB <- as.data.frame(DOB)



#Address
data <- read.csv("data.csv")
address_2 <- 0

#Password
password<- stri_rand_strings(n=sample_size, length=15, pattern="[A-Za-z0-9]")
password <- as.data.frame(password)

a <- data.frame(DOB,Phone_num, user_type, Email, password)



user <- names
user$First_name <- as.character(names$First_name)
user$Last_name <- as.character(names$Last_name)
user$Address_1 <- as.character(data$Street.Address)
user$Address_2 <- as.character(0)
user$City <- as.character(data$City)
user$State <- as.character(data$State)
user$Zipcode <- as.integer(data$Zip.Code)
user$DOB <- a$DOB
user$Phone_num <- a$Phone_num
user$Email <- as.character(a$Email)
user$Password <- as.character(a$password)
user <- user[, -c(1:2)]
user <- tibble::rowid_to_column(user, "id")
user <- left_join(user, zipcode, by= "Zipcode")


dbWriteTable(con, "User", user, overwrite = TRUE)

```

```{r foreign keys}
owner_id <- user[sample(nrow(user), 399), 1]
user[owner_id,1]
lessee_id <- user[-owner_id,1]
```

```{r owner}

#Company Name 
company_names <- lapply(paste0('http://www.hoovers.com/company-information/company-search.html?term=warehousing-and-storage--&nvcnt=76&maxitems=100&page=', 1:10,sep="/"),
                function(url){
                  url %>% read_html() %>% 
                    html_nodes(".company_name") %>% 
                    html_text() %>%
                    str_trim() 
                })
company_names <- unlist(company_names)
company_names<- as.data.frame(company_names)
owner <- company_names
colnames(owner)[1] <- "Company_name"

#Bank Account Number 
bank_account <- sample(10000000000:999999999999, nrow(company_names),replace=TRUE)
bank_account <- as.data.frame(bank_account)

#Routing Number
routing_number <- sample(1e9:1e10,nrow(company_names),replace=TRUE)
routing_number <- as.data.frame(routing_number)


a <- bind_cols(bank_account,routing_number)
owner$bank_acc <- a$bank_account
owner$routing_num <- a$routing_number

specific <- sample(1:1000,3)
owner <- owner[sample(nrow(owner),399),]

owner$owner_id <- owner_id 
owner <- owner[c(4,1,2,3)]

dbWriteTable(con, "Owner", owner, overwrite = TRUE)

```

```{r lessee}
lesse_num <- nrow(owner) * 100
credit_card_num <- r_credit_card_numbers(lesse_num)
credit_card_num <- gsub("-","", credit_card_num)
credit_card_num <- as.data.frame(credit_card_num)

expiration_month <- sample(1:12,lesse_num, replace = TRUE)
expiration_year <- sample(2018:2050, lesse_num, replace = TRUE)
expiration <- data.frame(expiration_month, expiration_year)
CVC <- sample(100:999, lesse_num, replace = TRUE)
CVC <- as.data.frame(CVC)

lessee_id <- as.data.frame(lessee_id)
lessee <- bind_cols(lessee_id,credit_card_num,expiration, CVC)

dbWriteTable(con, "Lessee", lessee, overwrite = TRUE)

```

```{r warehouse}
Street <- lapply(paste0("https://www.loopnet.com/warehouses-for-lease/", 1:20,sep="/"),
                function(url){
                  url %>% read_html() %>% 
                    html_nodes(".listingTitle") %>% 
                    html_text() %>%
                    str_trim() %>%
                    gsub('-* Warehouse for Lease', '', .)
                  
              })

Street <- unlist(Street)
Street <- as.data.frame(Street)


#City and State 
city_state <- lapply(paste0('https://www.loopnet.com/warehouses-for-lease/', 1:20,sep="/"),
                 function(url){
                   url %>% read_html() %>% 
                     html_nodes(".listingDescription b") %>% 
                     html_text() %>%
                     str_trim()
                   
                 })

city_state <- unlist(city_state)
city_state <- as.data.frame(city_state)
city_state <- city_state %>% separate(city_state, sep = "," ,c("city","State"))

#Zipcodes
zipcodes <- read.csv("test.csv") %>% select("Zipcode", "ID")

#Attributes 
df1 <- lapply(paste0('https://www.loopnet.com/warehouses-for-lease/', 1:20,sep="/"),
                     function(url){
                       url %>% read_html() %>% 
                         html_nodes(".listingAttributes tr") %>% 
                         html_text() %>%
                         str_trim()
                     })

df1 <- unlist(df1)
df1 <- as.data.frame(df1)

#Price per skid per month 
price <- df1 %>% filter(str_detect(df1,"Price:")) %>%
  separate(df1, sep = ":", c("Text","Fee")) %>%
  separate(Fee, sep = "-", c("Fee", "Max"))

price$Text <- NULL
price$Max <- NULL

price$Fee <- gsub("[^0-9\\.]", "", price$Fee)
price <- as.numeric(price$Fee) 
price <- as.data.frame(price)

#Building Size 
building_size <- df1 %>% filter(str_detect(df1, "Building Size")) %>%
  separate(df1, sep = ":", c("Text", "Size"))
building_size$Text <- NULL
building_size$Size <- gsub("[^0-9\\]", "", building_size$Size) 
Size <- as.numeric(building_size$Size)
Size <- as.data.frame(Size)

#Temperature control 
temp <- c("dry", "temp_controlled", "cooler", "frozen")

#Capacity
capacity <- floor(capacity_find(warehouse$Size))

#Warehouse data frame 
warehouse <- data.frame(Street,city_state,price, Size) 
warehouse <- as.data.frame(warehouse) %>%
  mutate(price = price * 12) %>% 
  mutate(price, replace(price, price > 30, NA)) %>%
  na.omit
warehouse$`replace(price, price > 30, NA)` <- NULL

warehouse <- left_join(warehouse,zipcode, by = "city")

warehouse <- tibble::rowid_to_column(warehouse, "ID")
warehouse <- left_join(warehouse, zipcodes, by = "ID")
warehouse <- warehouse %>% na.omit
warehouse$temp <- sample(temp, nrow(warehouse), replace = TRUE, prob = c(.30,.50,.15,.05))
warehouse$capacity <- capacity
warehouse$lowest_temp[warehouse$temp == "frozen"] <- 0
warehouse$lowest_temp[warehouse$temp == "cooler"] <- 34
warehouse$lowest_temp[warehouse$temp == "temp_controlled"] <- 55
warehouse$lowest_temp[warehouse$temp == "dry"] <- 75
warehouse$highest_temp <- 75 
warehouse$Price_per_skid <- warehouse$price *16 / 365
warehouse$Adress_2 <- 0
warehouse$ID <- NULL


warehouse %>% select(city, S)


warehouse <- warehouse[c(1,2,12,3,4,5,6,7,8,9,10,11)]
warehouse <- as.data.frame(warehouse)
warehouse$owner_id <- owner$owner_id
head(warehouse)


head(warehouse)
dbWriteTable(con, "Warehouse", warehouse, overwrite = TRUE)

```

```{r contract}
selected_id <- sample(nrow(lessee), 1, 1)
lessee_pref <- sample(temp, 1)
selected_user <- user[selected_id, ]



  
distance <- mapply(distance_calc, warehouse$longitude, warehouse$latitude)
distance <- distance * 0.000621371

warehouses <- warehouse[which(distance < 200),]

warehouses <- warehouse[which(warehouse$temp == lessee_pref),]

warehouses <- which(distance < 200)
selected_warehouse <- sample(nrow(warehouse),1,)

start_date <- sample(seq(as.Date('2018/01/01'), as.Date('2018/12/30'), by="day"), 1)

repeat {
    end_date <- sample(seq(as.Date('2018/01/02'), as.Date('2018/12/31'), by="day"), 1)
    if (end_date > start_date){
      break
    }
}

date_diff <-  as.Date(start_date, format="%Y/%m/%d")- as.Date(end_date, format="%Y/%m/%d")
num_skids <- repeat {
    num_skids <- rnorm(1, mean=20, sd=30)
    num_skids <- num_skids - (num_skids %% 1)
    if (num_skids > 0){
      break
    }
    return(num_skids)
}

total_price <- num_skids * selected_warehouse[9] * date_diff 



contract <- data.frame(selected_warehouse[,1],start_date, end_date, total_price, selected_user)
```

```{r function}
#This function is for the capacity of each warehouse depending on their size. We have used a source from 

capacity_find <- function(size){
  utilization <- rnorm(1, mean = .55)
  stack_height <- sample(c(1,2,3,4))
  capacity <- size * utilization * stack_height / 16
  return(capacity)
}

calc_dist <- function(lon,lat){
  distm(c(user[selected_id,]$longitude, user[selected_id,]$latitude), c(lon , lat), fun = distHaversine)   
}
